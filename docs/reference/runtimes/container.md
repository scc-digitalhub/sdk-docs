# Container runtime

The Container runtime enables launching pods, jobs and services on Kubernetes. It is designed for remote, online execution.

## Prerequisites

Supported Python version and required package:

- `python >= 3.9, <3.13`
- `digitalhub-runtime-container`

Install the runtime from PyPI:

```bash
python -m pip install digitalhub-runtime-container
```

## Overview

Use the Container runtime to run containers on Kubernetes. It exposes a Function of kind `container` and several task actions to run jobs, serve services, build images, or deploy workloads.

### Function

The Container runtime introduces a Function of kind `container` that describes how to execute a container-based workload.

#### Function parameters

| Name | Type | Description |
| --- | --- | --- |
| project | str | Project name. Required only when creating from the library; otherwise **MUST NOT** be set. |
| name | str | Name that identifies the object. **Required.** |
| [kind](#function-kinds) | str | Function kind. **Required.** |
| uuid | str | Object ID in UUID4 format. |
| description | str | Description of the object. |
| labels | list[str] | List of labels. |
| embedded | bool | Whether the object should be embedded in the project. |
| [code_src](../configuration/code_src/overview.md#code-source-uri) | str | URI pointing to the source code. |
| [code](../configuration/code_src/overview.md#plain-text-source) | str | Source code provided as plain text. |
| base64 | str | Source code encoded as base64. |
| [handler](../configuration/code_src/overview.md#handler) | str | Function entrypoint. |
| lang | str | Source code language (informational). |
| image | str | Container image to use for execution (name:tag). |
| base_image | str | Base image used when building the execution image. (Required if task is `build`) |
| image_pull_policy | str | Kubernetes image pull policy. |
| command | str | Command to run inside the container. |

##### Function kinds

The `kind` parameter must be:

- `container`

### Task

The Container runtime supports four task actions: `job`, `serve`, `build`, and `deploy`. A `Task` is created via the `run()` method; task parameters are passed through that call and differ by action. Below are the shared parameters, followed by action-specific parameters and small examples for each action.

#### Task parameters (shared)

| Name | Type | Description |
| --- | --- | --- |
| [action](#task-actions) | str | Task action. One of: `job`, `build`, `serve`, `deploy`. **Required** |
| [node_selector](../configuration/kubernetes/overview.md#node-selector) | list[dict] | Node selector. |
| [volumes](../configuration/kubernetes/overview.md#volumes) | list[dict] | List of volumes. |
| [resources](../configuration/kubernetes/overview.md#resources) | dict | Resource limits/requests. Example: `{"limits": {"cpu": "1", "memory": "512Mi"}, "requests": {"cpu": "250m", "memory": "128Mi"}}`. |
| [affinity](../configuration/kubernetes/overview.md#affinity) | dict | Affinity configuration. |
| [tolerations](../configuration/kubernetes/overview.md#tolerations) | list[dict] | Tolerations. |
| [envs](../configuration/kubernetes/overview.md#secrets-envs) | list[dict] | Environment variables. Example: `[{"name": "FOO", "value": "bar"}]`. |
| [secrets](../configuration/kubernetes/overview.md#secrets-envs) | list[str] | List of secret names. |
| [profile](../configuration/kubernetes/overview.md#profile) | str | Profile template. |

#### Action-specific parameters

- `job`

| Name | Type | Description |
| --- | --- | --- |
| [fs_group](../configuration/kubernetes/overview.md#security-context) | int | File system group ID. |
| [run_as_user](../configuration/kubernetes/overview.md#security-context) | int | User ID to run the container. |
| [run_as_group](../configuration/kubernetes/overview.md#security-context) | int | Group ID to run the container. |

- `serve`

| Name | Type | Description |
| --- | --- | --- |
| [replicas](../configuration/kubernetes/overview.md#replicas) | int | Number of replicas. |
| [service_ports](../configuration/kubernetes/overview.md#service-port-type) | list[dict] | Ports to expose for the service. Example: `[{"port": 80, "targetPort": 8080}]`. |
| [service_type](../configuration/kubernetes/overview.md#service-port-type) | str | Service type. |
| [run_as_user](../configuration/kubernetes/overview.md#security-context) | int | User ID to run the container. |
| [run_as_group](../configuration/kubernetes/overview.md#security-context) | int | Group ID to run the container. |

- `build`

| Name | Type | Description |
| --- | --- | --- |
| [instructions](#instructions) | list[str] | Build instructions executed as RUN lines in the generated Dockerfile. |
| base_image | str | Base image used when building the execution image. Required for `build` unless a full image is provided. |
| image | str | Target image name:tag to build/push. If not provided, a local image name may be generated by the runtime. |

- `deploy`

| Name | Type | Description |
| --- | --- | --- |
| [replicas](../configuration/kubernetes/overview.md#replicas) | int | Number of replicas. |
| [fs_group](../configuration/kubernetes/overview.md#security-context) | int | File system group ID. |
| [run_as_user](../configuration/kubernetes/overview.md#security-context) | int | User ID to run the container. |
| [run_as_group](../configuration/kubernetes/overview.md#security-context) | int | Group ID to run the container. |

##### Instructions

Instructions are executed as `RUN` instructions in the generated Dockerfile. Example:

```python
instructions = ["apt-get install -y git"]
```

##### Task actions

Supported actions:

- `job`
- `build`
- `serve`
- `deploy`

### Run

The `Run` object is created by calling `run()` on a `Function`. Run-level parameters are provided alongside task parameters.

#### Run parameters

| Name | Type | Description |
| --- | --- | --- |
| args | list[str] | Command-line arguments to pass to the container command. |

#### Run methods

There are no runtime-specific helper methods for container runs.

## Examples

Function example

```python
import digitalhub as dh

project = dh.get_or_create_project('my_project')
function = dh.new_function(
    kind='container',
    name='my_function',
    image='hello-world:latest'
)
```

Job example (existing):

```python
run = function.run(
    action='job',
    instructions=["apt install git -y"],
)
```

Build example (builds an image from source using a base image and instructions):

```python
run = function.run(
    action='build',
    base_image='python:3.11-slim',
    instructions=["apt-get update && apt-get install -y git"],
    image='myrepo/myapp:0.1.0'
)
```

Serve example (exposes a service):

```python
run = function.run(
    action='serve',
    replicas=2,
    service_ports=[{"port": 8080, "targetPort": 8080}],
    service_type='NodePort'
)
```

Deploy example (deploy an application workload):

```python
run = function.run(
    action='deploy',
    replicas=3,
    envs=[{"name": "ENV", "value": "prod"}],
    volumes=[{"name": "data", "mountPath": "/data"}]
)
```
